#!/usr/bin/env ruby

if $0 == __FILE__
  $:.unshift File.expand_path('../../lib', __FILE__)
end

require 'xclisten'
require 'listen'
require 'optparse'

@options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: xclisten [optional flags]"
  opts.on('--osx', 'Run with OSX sdk (without simulator)') do
    @options[:sdk] = 'macosx'
  end
  opts.on('--ios', '[DEFAULT] Run with iOS sdk') do
    @options[:sdk] = 'iphonesimulator'
  end
  opts.on('-d', '--device', 'Simulated device [iphone5s, iphone5, iphone4]. Default is iphone5s') do |device|
    @options[:device] = device
  end
  opts.on('-s', '--scheme SCHEME', 'BYOS (Bring your own scheme)') do |scheme|
    @options[:scheme] = scheme
  end
  opts.on('-w', '--workspace WORKSPACE', 'BYOW (Bring your own workspace)') do |workspace|
    @options[:workspace] = workspace
  end
  opts.on("--print-settings", "Show build settings and exit") do
    @printsettings = true
  end
  opts.on_tail('-h', '--help', 'Show this message') { puts opts; exit }
  opts.on_tail("-v", "--version", "Show version") { puts XCListen::VERSION; exit }
  opts.parse!
end

if XCListen.can_run?
  if @printsettings
    XCListen.new(@options).print_settings
  else
    pid = fork     { XCListen.new(@options).listen }
    trap("SIGINT") { Process.kill(9, pid) }
    Process.wait(pid)
  end
else
  puts "[!] No xcworkspace found in this directory (or any child directories)"
  exit 1
end

